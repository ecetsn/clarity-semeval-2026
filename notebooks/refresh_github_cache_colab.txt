# ============================================================================
# GITHUB CACHE REFRESH - Run this cell to get latest code from GitHub
# ============================================================================
# This cell removes the old repository and clones fresh from GitHub
# Use this when you need to update to the latest code

import shutil
import os
import subprocess
import sys
import time
import requests
import zipfile
from pathlib import Path

# Repository configuration
repo_dir = Path('/content/semeval-context-tree-modular')
repo_url = 'https://github.com/EonTechie/semeval-context-tree-modular.git'
zip_url = 'https://github.com/EonTechie/semeval-context-tree-modular/archive/refs/heads/main.zip'

print("="*80)
print("GITHUB CACHE REFRESH")
print("="*80)

# Step 1: Remove old repository if exists
if repo_dir.exists():
    print(f"\n1. Removing old repository: {repo_dir}")
    try:
        shutil.rmtree(repo_dir)
        print("   ✓ Old repository removed")
    except Exception as e:
        print(f"   ⚠ Error removing: {e}")
        subprocess.run(['rm', '-rf', str(repo_dir)], check=False)
else:
    print(f"\n1. No existing repository found")

# Step 2: Clone fresh repository
print(f"\n2. Cloning fresh repository from GitHub...")
max_retries = 3
clone_success = False

for attempt in range(max_retries):
    try:
        print(f"   Attempt {attempt + 1}/{max_retries}...")
        result = subprocess.run(
            ['git', 'clone', repo_url, str(repo_dir)],
            cwd='/content',
            capture_output=True,
            text=True,
            timeout=120
        )
        if result.returncode == 0:
            print("   ✓ Repository cloned successfully")
            clone_success = True
            break
        else:
            if attempt < max_retries - 1:
                time.sleep(3)
    except Exception as e:
        if attempt < max_retries - 1:
            time.sleep(3)

# Fallback: Download as ZIP
if not clone_success:
    print("   ⚠ Git clone failed. Trying ZIP download...")
    try:
        zip_path = '/tmp/repo.zip'
        response = requests.get(zip_url, stream=True, timeout=120)
        response.raise_for_status()
        with open(zip_path, 'wb') as f:
            for chunk in response.iter_content(chunk_size=8192):
                f.write(chunk)
        with zipfile.ZipFile(zip_path, 'r') as zip_ref:
            zip_ref.extractall('/content')
        extracted_dir = Path('/content/semeval-context-tree-modular-main')
        if extracted_dir.exists():
            if repo_dir.exists():
                shutil.rmtree(repo_dir)
            extracted_dir.rename(repo_dir)
        os.remove(zip_path)
        print("   ✓ Repository downloaded and extracted")
        clone_success = True
    except Exception as e:
        raise RuntimeError(f"Failed to obtain repository: {e}")

# Step 3: Verify and update Python path
print(f"\n3. Verifying repository structure...")
if not (repo_dir / 'src').exists():
    raise RuntimeError(f"src directory not found")

if str(repo_dir) not in sys.path:
    sys.path.insert(0, str(repo_dir))

# Step 4: Verify imports
print(f"\n4. Verifying imports...")
try:
    from src.storage.manager import StorageManager
    from src.utils.reproducibility import set_all_seeds
    from src.features.extraction import (
        featurize_hf_dataset_in_batches_v2,
        featurize_model_independent_features
    )
    print("   ✓ All imports successful")
except ImportError as e:
    raise ImportError(f"Import failed: {e}")

print(f"\n{'='*80}")
print("✓ GITHUB CACHE REFRESH COMPLETE")
print(f"{'='*80}")
print(f"\nRepository: {repo_dir}")
print("You can now proceed with your notebook cells.")

